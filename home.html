<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>THE BEST - منصة الصف الثالث الثانوي</title>
  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #0d0d0d; color: #fff; margin: 0; padding: 0; }
    header { background-color: #1a1a1a; padding: 20px; text-align: center; font-size: 22px; font-weight: bold; color: #ffd700; box-shadow: 0 2px 10px rgba(255, 215, 0, 0.3); letter-spacing: 1px; }
    #countdown-box { display:flex; justify-content:center; gap:15px; font-size:18px; font-weight:bold; }
    .time-block { background: #333; padding: 8px 12px; border-radius: 10px; min-width: 60px; text-align: center; color: #ffd700; }
    .time-block span { font-size: 20px; display: block; }
    #expired-msg { font-size: 24px; font-weight: bold; color: red; animation: shake 0.5s infinite, blink 1s infinite; display: none; }
    @keyframes shake { 0%{transform:translateX(0)}25%{transform:translateX(-5px)}50%{transform:translateX(5px)}75%{transform:translateX(-5px)}100%{transform:translateX(0)} }
    @keyframes blink { 0%,50%,100%{opacity:1}25%,75%{opacity:0} }

    .filter-bar { display: none; justify-content: center; gap: 10px; margin: 20px; flex-wrap: wrap; }
    .filter-bar button { background-color: #2b2b2b; color: #ffd700; border: 1px solid #444; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; transition: all 0.2s ease-in-out; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); }
    .filter-bar button:hover { background-color: #3a3a3a; transform: scale(1.05); box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
    .filter-bar button:active { transform: scale(0.95); box-shadow: inset 0 0 8px rgba(255, 215, 0, 0.2); }

    #teachers-filter { text-align: center; margin-bottom: 20px; }
    #teachers-filter button { margin: 0 10px; padding: 8px 16px; border-radius: 8px; border: none; background-color: #444; color: #ffd700; cursor: pointer; font-weight: bold; transition: background-color 0.3s ease; }
    #teachers-filter button:hover { background-color: #555; }
    #teachers-filter button.active { background-color: #ffd700; color: #1a1a1a; }

    #videos-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; padding: 20px; }
    .video-box { background-color: #1a1a1a; padding: 10px; border-radius: 12px; box-shadow: 0 0 10px rgba(255, 215, 0, 0.1); transition: transform 0.2s ease-in-out, box-shadow 0.2s; }
    .video-box:hover { transform: translateY(-5px); box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
    video { width: 100%; height: 250px; border-radius: 10px; background-color: #000; }
    .video-title { margin: 10px 0 6px 0; font-size: 18px; color: #ffd700; text-align: center; }
    .video-teacher { text-align: center; font-size: 14px; margin-bottom: 6px; color: #bbb; }
    footer { background-color: #1a1a1a; padding: 20px; text-align: center; color: #888; font-size: 14px; margin-top: 40px; }

    #login-box { text-align: center; margin: 20px; }
    #studentCode { padding: 8px 12px; border-radius: 8px; border: 1px solid #444; margin-left: 10px; }
    #loginBtn { padding: 8px 16px; border-radius: 8px; border: none; background: #ffd700; color: #1a1a1a; font-weight: bold; cursor: pointer; }

    /* الرسالة المنبثقة */
    #messageBox {
      position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 9999;
      background: rgba(0,0,0,0.55);
    }
    #messageBox .card {
      background:#1a1a1a; border-radius:12px; padding:20px 26px; font-weight:bold; text-align:center; min-width:260px;
      box-shadow: 0 0 20px rgba(0,0,0,0.6); animation: fadeIn .25s ease-out;
      border:2px solid #333; color:#fff;
    }
    #messageBox.success .card{ border-color:#00ff88; color:#00ff88; }
    #messageBox.error .card{ border-color:#ff4444; color:#ff4444; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(-8px)} to{opacity:1; transform:translateY(0)} }
  </style>
</head>
<body>
  <header>
    <section id="countdown-box">
      <div class="time-block"><span id="days">--</span>أيام</div>
      <div class="time-block"><span id="hours">--</span>ساعات</div>
      <div class="time-block"><span id="minutes">--</span>دقائق</div>
      <div class="time-block"><span id="seconds">--</span>ثواني</div>
    </section>
    <div id="expired-msg">🚫 تم انتهاء الاشتراك 🚫</div>
  </header>

  <div id="login-box">
    <input type="text" id="studentCode" placeholder="ادخل كود الاشتراك" />
    <button id="loginBtn">دخول</button>
  </div>

  <div class="filter-bar">
    <button onclick="filterVideos('إنجليزي')">E</button>
    <button onclick="filterVideos('عربي')">عربي</button>
    <button onclick="filterVideos('فيزياء')">فيزياء</button>
    <button onclick="filterVideos('رياضيات')">رياضيات</button>
    <button onclick="filterVideos('كيمياء')">كيمياء</button>
    <button onclick="filterVideos('أحياء')">أحياء</button>
  </div>

  <div id="teachers-filter"></div>

  <main id="videos-container">
    <div class="loading" style="text-align:center; font-size:18px; color:#ffd700;">
      مرحبا بك في منصه الصف الثالث الثانوي العام منصه THE BEST.
    </div>
  </main>

  <footer>جميع الحقوق محفوظة © منصة THE BEST - 2025</footer>

  <!-- الرسالة المنبثقة -->
  <div id="messageBox"><div class="card"></div></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAdz_OsGPL5xEq-J72FCkuQezVMhU_FATo",
      authDomain: "website-83e14.firebaseapp.com",
      databaseURL: "https://website-83e14-default-rtdb.firebaseio.com",
      projectId: "website-83e14",
      storageBucket: "website-83e14.appspot.com",
      messagingSenderId: "994953388464",
      appId: "1:994953388464:web:13890d9d1448c45061f675",
      measurementId: "G-CTHDFE44WE"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const videosContainer = document.getElementById('videos-container');
    const teachersFilter  = document.getElementById('teachers-filter');
    const countdownBox    = document.getElementById('countdown-box');
    const expiredMsg      = document.getElementById('expired-msg');
    const daysEl          = document.getElementById('days');
    const hoursEl         = document.getElementById('hours');
    const minutesEl       = document.getElementById('minutes');
    const secondsEl       = document.getElementById('seconds');

    let allVideos = [];
    let selectedSubject = null;
    let selectedTeacher = null;
    let isLoggedIn = false;

    /* =================== أدوات مساعدة لليوتيوب =================== */
    function getYouTubeId(url = "") {
      try {
        // youtu.be/ID
        const short = url.match(/youtu\.be\/([^?&#/]+)/i);
        if (short) return short[1];

        // youtube.com/watch?v=ID
        const watch = url.match(/[?&]v=([^?&#/]+)/i);
        if (watch) return watch[1];

        // youtube.com/shorts/ID
        const shorts = url.match(/youtube\.com\/shorts\/([^?&#/]+)/i);
        if (shorts) return shorts[1];

        // youtube.com/embed/ID
        const embed = url.match(/youtube\.com\/embed\/([^?&#/]+)/i);
        if (embed) return embed[1];

        return null;
      } catch { return null; }
    }

    function getYouTubeEmbedUrl(url = "") {
      const id = getYouTubeId(url);
      if (!id) return null;
      return https://www.youtube.com/embed/${id};
    }

    // رسالة منبثقة
    function showMessage(msg, type="success", duration=2000){
      const box = document.getElementById('messageBox');
      const card = box.querySelector('.card');
      card.textContent = msg;
      box.className = type; // success | error
      box.style.display = 'flex';
      clearTimeout(showMessage._t);
      showMessage._t = setTimeout(()=>{ box.style.display='none'; }, duration);
    }

    // زر الدخول
    document.getElementById('loginBtn').addEventListener('click', loginWithCode);
    document.getElementById('studentCode').addEventListener('keydown', e=>{
      if(e.key === 'Enter') loginWithCode();
    });

    function loginWithCode(){
      const code = document.getElementById('studentCode').value.trim();
      if(!code){ showMessage("⚠ من فضلك ادخل كود الاشتراك","error"); return; }
      localStorage.setItem('studentCode', code);

      const codeRef = ref(db, codes/${code}/expire);
      onValue(codeRef, (snapshot)=>{
        const expireValue = snapshot.val();
        const now = Date.now();
        if (expireValue && now <= parseInt(expireValue)) {
          startCountdown(expireValue);
          document.getElementById('login-box').innerHTML = "✅ تم تسجيل الدخول بنجاح";
          showMessage("✅ تم تسجيل الدخول بنجاح","success");
          isLoggedIn = true;
          if (allVideos.length > 0) {
            videosContainer.innerHTML = '<div style="text-align:center; font-size:18px; color:#ffd700;">مده الاشتراك الخاصه بك شهر نتمني لك وقت جيدا</div>';
            document.querySelector('.filter-bar').style.display = 'flex';
          } else {
            renderLoginRequired();
          }
        } else {
          showMessage("❌ الكود غير صحيح أو منتهي","error");
          localStorage.removeItem('studentCode');
          isLoggedIn = false;
          renderLoginRequired();
        }
      }, { onlyOnce: true });
    }

    // تحقق تلقائي عند الفتح
    const savedCode = localStorage.getItem('studentCode');
    if (savedCode){
      const codeRef = ref(db, codes/${savedCode}/expire);
      onValue(codeRef, (snapshot)=>{
        const expireValue = snapshot.val();
        const now = Date.now();
        if (expireValue && now <= parseInt(expireValue)) {
          startCountdown(expireValue);
          document.getElementById('login-box').innerHTML = "✅ تم تسجيل الدخول بنجاح";
          showMessage("✅ تم تسجيل الدخول بنجاح","success");
          isLoggedIn = true;
          if (allVideos.length > 0) {
            videosContainer.innerHTML = '<div style="text-align:center; font-size:18px; color:#ffd700;">مده الاشتراك الخاصه بك شهر نتمني لك وقت جيدا</div>';
            document.querySelector('.filter-bar').style.display = 'flex';
          } else {
            renderLoginRequired();
          }
        } else {
          localStorage.removeItem('studentCode');
          isLoggedIn = false;
          renderLoginRequired();
        }
      }, { onlyOnce: true });
    }

    function startCountdown(endTimestamp){
      const end = parseInt(endTimestamp);
      const interval = setInterval(()=>{
        const now = Date.now();
        const distance = end - now;

        if (distance <= 0){
          clearInterval(interval);
          countdownBox.style.display = 'none';
          expiredMsg.style.display = 'block';
          isLoggedIn = false;
          localStorage.removeItem('studentCode');

          document.getElementById('login-box').innerHTML = `
            <input type="text" id="studentCode" placeholder="ادخل كود الاشتراك" />
            <button id="loginBtn">دخول</button>
          `;
          document.getElementById('loginBtn').addEventListener('click', loginWithCode);
          document.getElementById('studentCode').addEventListener('keydown', e=>{
            if(e.key === 'Enter') loginWithCode();
          });

          videosContainer.innerHTML = '<div style="text-align:center; font-size:18px; color:#ffd700;">❌ يجب إدخال كود اشتراك صالح لتفعيل الفيديوهات</div>';
          teachersFilter.innerHTML = '';
          document.querySelector('.filter-bar').style.display = 'none';
          return;
        }

        const days    = Math.floor(distance / (1000*60*60*24));
        const hours   = Math.floor((distance % (1000*60*60*24)) / (1000*60*60));
        const minutes = Math.floor((distance % (1000*60*60)) / (1000*60));
        const seconds = Math.floor((distance % (1000*60)) / 1000);

        daysEl.textContent    = days;
        hoursEl.textContent   = hours;
        minutesEl.textContent = minutes;
        secondsEl.textContent = seconds;
      }, 1000);
    }

    function renderLoginRequired(){
      videosContainer.innerHTML = '<div style="text-align:center; font-size:18px; color:red;">❌ يجب إدخال كود الاشتراك الخاص بك لتفعيل الفيديوهات</div>';
      teachersFilter.innerHTML = '';
      document.querySelector('.filter-bar').style.display = 'none';
    }

    function renderTeachers(subject){
      if(!isLoggedIn){ renderLoginRequired(); return; }
      teachersFilter.innerHTML = '';
      selectedTeacher = null;

      const teachersSet = new Set(
        allVideos
          .filter(v => (v.subject || '').trim() === subject)
          .map(v => (v.teacher || 'مدرس غير معروف').trim())
      );

      if (teachersSet.size === 0){
        teachersFilter.innerHTML = '<div style="text-align:center; color:#ffd700; font-size:18px;">لا يوجد مدرسين متاحين لهذه المادة.</div>';
        return;
      }

      teachersSet.forEach(teacher=>{
        const btn = document.createElement('button');
        btn.textContent = teacher;
        btn.onclick = ()=>{
          selectedTeacher = teacher;
          [...teachersFilter.children].forEach(c=>c.classList.remove('active'));
          btn.classList.add('active');
          renderVideos(selectedSubject, selectedTeacher);
        };
        teachersFilter.appendChild(btn);
      });
    }

    // ======= عرض الفيديوهات (يوتيوب بصورة مخصصة أو MP4 بـ poster) =======
    function renderVideos(subject, teacher=null){
      if(!isLoggedIn){ renderLoginRequired(); return; }
      videosContainer.innerHTML = '';
      selectedSubject = subject;

      let filtered = allVideos.filter(v => (v.subject || '').trim() === subject);
      if (teacher) filtered = filtered.filter(v => ((v.teacher || 'مدرس غير معروف').trim() === teacher));

      if (filtered.length === 0){
        videosContainer.innerHTML = '<div style="text-align:center; font-size:18px; color:#ffd700;">لا توجد فيديوهات لهذه المادة مع هذا المدرس.</div>';
        return;
      }

      filtered.forEach(video=>{
        const box = document.createElement('div');
        box.className = 'video-box';

        const isYouTube = /youtube\.com|youtu\.be/i.test(video.url || "");
        const imgUrl = (video.imageUrl || '').trim() || '';

        let videoContent = "";

        if (isYouTube) {
          // صورة مخصصة + أيقونة تشغيل
          videoContent = `
            <div class="video-thumbnail" style="position:relative; cursor:pointer; width:100%; height:250px; border-radius:10px; overflow:hidden; background:#000;">
              <img src="${imgUrl}" alt="thumbnail" style="width:100%; height:100%; object-fit:cover; display:block;">
              <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
                          font-size:40px;color:#fff;background:rgba(0,0,0,0.5);
                          padding:10px 20px;border-radius:50%; line-height:1;">▶</div>
            </div>
          `;
        } else {
          // MP4 عادي
          videoContent = `
            <video controls poster="${imgUrl}">
              <source src="${video.url}" type="video/mp4">
              متصفحك لا يدعم تشغيل الفيديو.
            </video>
          `;
        }

        box.innerHTML = `
          <div class="video-title">${video.title || 'فيديو بدون عنوان'}</div>
          <div class="video-teacher">المدرس: ${video.teacher || 'غير معروف'}</div>
          ${videoContent}
        `;

        // استبدال الصورة بإطار يوتيوب عند الضغط
        if (isYouTube) {
          const thumbDiv = box.querySelector(".video-thumbnail");
          thumbDiv.addEventListener("click", ()=>{
            const embed = getYouTubeEmbedUrl(video.url) ||
                          (video.url || "").replace("watch?v=", "embed/").replace("/shorts/", "/embed/");

            const iframe = document.createElement("iframe");
            iframe.width = "100%";
            iframe.height = "250";
            iframe.src = ${embed}?rel=0&autoplay=1;
            iframe.frameBorder = "0";
            iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
            iframe.allowFullscreen = true;
            thumbDiv.replaceWith(iframe);
          });
        }

        videosContainer.appendChild(box);
      });
    }

    // متاح للأزرار
    window.filterVideos = (subject)=>{
      if(!isLoggedIn){ renderLoginRequired(); return; }
      if (subject === 'all'){
        videosContainer.innerHTML = '<div style="text-align:center; font-size:18px; color:#ffd700;">اضغط علي اسم المادة للحصول على الفيديوهات.</div>';
        teachersFilter.innerHTML = '';
        selectedSubject = null;
        selectedTeacher = null;
        return;
      }
      selectedSubject = subject;
      selectedTeacher = null;
      renderTeachers(subject);
      videosContainer.innerHTML = '<div style="text-align:center; font-size:18px; color:#ffd700;">اختر مدرس لعرض الفيديوهات.</div>';
    };

    // تحميل الفيديوهات من Realtime Database
    const videosRef = ref(db, 'videos');
    onValue(videosRef, (snapshot)=>{
      const data = snapshot.val() || {};
      allVideos = Object.keys(data).map(k => ({
        url: data[k].url,
        subject: data[k].subject || '',
        title: data[k].title || '',
        teacher: data[k].teacher || 'مدرس غير معروف',
        imageUrl: data[k].imageUrl || ''
      }));

      if (isLoggedIn){
        videosContainer.innerHTML = '<div style="text-align:center; font-size:18px; color:#ffd700;">مده الاشتراك الخاصه بك شهر نتمني لك وقت جيدا</div>';
        document.querySelector('.filter-bar').style.display = 'flex';
      } else {
        renderLoginRequired();
      }
      teachersFilter.innerHTML = '';
    });
  </script>
</body>
</html>
