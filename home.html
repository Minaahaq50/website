<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>THE BEST - منصة الصف الثالث الثانوي</title>
  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #0d0d0d; color: #fff; margin: 0; padding: 0; }
    header { background-color: #1a1a1a; padding: 20px; text-align: center; font-size: 22px; font-weight: bold; color: #ffd700; box-shadow: 0 2px 10px rgba(255, 215, 0, 0.3); letter-spacing: 1px; }
    #countdown-box { display:flex; justify-content:center; gap:15px; font-size:18px; font-weight:bold; }
    .time-block { background: #333; padding: 8px 12px; border-radius: 10px; min-width: 60px; text-align: center; color: #ffd700; }
    .time-block span { font-size: 20px; display: block; }
    #expired-msg { font-size: 24px; font-weight: bold; color: red; animation: shake 0.5s infinite, blink 1s infinite; display: none; }
    @keyframes shake { 0%{transform:translateX(0)}25%{transform:translateX(-5px)}50%{transform:translateX(5px)}75%{transform:translateX(-5px)}100%{transform:translateX(0)} }
    @keyframes blink { 0%,50%,100%{opacity:1}25%,75%{opacity:0} }

    .filter-bar { display: none; justify-content: center; gap: 10px; margin: 20px; flex-wrap: wrap; }
    .filter-bar button { background-color: #2b2b2b; color: #ffd700; border: 1px solid #444; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; transition: all 0.2s ease-in-out; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); }
    .filter-bar button:hover { background-color: #3a3a3a; transform: scale(1.05); box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
    .filter-bar button:active { transform: scale(0.95); box-shadow: inset 0 0 8px rgba(255, 215, 0, 0.2); }

    #teachers-filter { text-align: center; margin-bottom: 20px; }
    #teachers-filter button { margin: 0 10px; padding: 8px 16px; border-radius: 8px; border: none; background-color: #444; color: #ffd700; cursor: pointer; font-weight: bold; transition: background-color 0.3s ease; }
    #teachers-filter button:hover { background-color: #555; }
    #teachers-filter button.active { background-color: #ffd700; color: #1a1a1a; }

    #videos-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; padding: 20px; }
    .video-box { background-color: #1a1a1a; padding: 10px; border-radius: 12px; box-shadow: 0 0 10px rgba(255, 215, 0, 0.1); transition: transform 0.2s ease-in-out, box-shadow 0.2s; }
    .video-box:hover { transform: translateY(-5px); box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
    .video-title { margin: 10px 0 6px 0; font-size: 18px; color: #ffd700; text-align: center; }
    .video-teacher { text-align: center; font-size: 14px; margin-bottom: 10px; color: #bbb; }

    .thumb { position:relative; cursor:pointer; border-radius:10px; overflow:hidden; background:#000; }
    .thumb img { width:100%; display:block; }
    .thumb .play-btn {
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      font-size:50px; color:#ffd700; text-shadow:0 0 10px rgba(0,0,0,.9);
      user-select:none;
    }

    footer { background-color: #1a1a1a; padding: 20px; text-align: center; color: #888; font-size: 14px; margin-top: 40px; }

    #login-box { text-align: center; margin: 20px; }
    #studentCode { padding: 8px 12px; border-radius: 8px; border: 1px solid #444; margin-left: 10px; }
    #loginBtn { padding: 8px 16px; border-radius: 8px; border: none; background: #ffd700; color: #1a1a1a; font-weight: bold; cursor: pointer; }

    /* الرسالة المنبثقة */
    #messageBox { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 9999; background: rgba(0,0,0,0.55); }
    #messageBox .card { background:#1a1a1a; border-radius:12px; padding:20px 26px; font-weight:bold; text-align:center; min-width:260px; box-shadow: 0 0 20px rgba(0,0,0,0.6); animation: fadeIn .25s ease-out; border:2px solid #333; color:#fff; }
    #messageBox.success .card{ border-color:#00ff88; color:#00ff88; }
    #messageBox.error .card{ border-color:#ff4444; color:#ff4444; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(-8px)} to{opacity:1; transform:translateY(0)} }

    /* تحكم اليوتيوب */
    .video-wrapper { position: relative; overflow: hidden; border-radius: 10px; background: #000; }
    .video-wrapper iframe { width: 100%; height: 250px; border-radius: 10px; transition: transform 0.25s ease; transform-origin: center center; display: block; border: 0; }
    .video-wrapper .controls { margin-top: 8px; text-align: center; }
    .video-wrapper .controls button {
      margin: 0 5px; padding: 6px 12px;
      border: none; border-radius: 6px;
      background: #2b2b2b; color: #ffd700;
      cursor: pointer; font-weight: bold;
    }
    .video-wrapper .controls button:hover { background: #444; }

    /* عندما يكون العنصر داخل full-screen يمكننا تغيير بعض الخصائص لو احتجت */
    .video-wrapper.fullscreen iframe { width: 100vw; height: 100vh; border-radius: 0; }
  </style>
</head>
<body>
  <header>
    <section id="countdown-box">
      <div class="time-block"><span id="days">--</span>أيام</div>
      <div class="time-block"><span id="hours">--</span>ساعات</div>
      <div class="time-block"><span id="minutes">--</span>دقائق</div>
      <div class="time-block"><span id="seconds">--</span>ثواني</div>
    </section>
    <div id="expired-msg">🚫 تم انتهاء الاشتراك 🚫</div>
  </header>

  <div id="login-box">
    <input type="text" id="studentCode" placeholder="ادخل كود الاشتراك" />
    <button id="loginBtn">دخول</button>
  </div>

  <div class="filter-bar">
    <button onclick="filterVideos('إنجليزي')">إنجليزي</button>
    <button onclick="filterVideos('عربي')">عربي</button>
    <button onclick="filterVideos('فيزياء')">فيزياء</button>
    <button onclick="filterVideos('رياضيات')">رياضيات</button>
    <button onclick="filterVideos('كيمياء')">كيمياء</button>
    <button onclick="filterVideos('أحياء')">أحياء</button>
  </div>

  <div id="teachers-filter"></div>

  <main id="videos-container">
    <div class="loading" style="text-align:center; font-size:18px; color:#ffd700;">
      مرحبًا بك في منصة الصف الثالث الثانوي THE BEST.
    </div>
  </main>

  <footer>جميع الحقوق محفوظة © منصة THE BEST - 2025</footer>

  <!-- الرسالة المنبثقة -->
  <div id="messageBox"><div class="card"></div></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAdz_OsGPL5xEq-J72FCkuQezVMhU_FATo",
      authDomain: "website-83e14.firebaseapp.com",
      databaseURL: "https://website-83e14-default-rtdb.firebaseio.com",
      projectId: "website-83e14",
      storageBucket: "website-83e14.appspot.com",
      messagingSenderId: "994953388464",
      appId: "1:994953388464:web:13890d9d1448c45061f675",
      measurementId: "G-CTHDFE44WE"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const videosContainer = document.getElementById('videos-container');
    const teachersFilter  = document.getElementById('teachers-filter');
    const countdownBox    = document.getElementById('countdown-box');
    const expiredMsg      = document.getElementById('expired-msg');
    const daysEl          = document.getElementById('days');
    const hoursEl         = document.getElementById('hours');
    const minutesEl       = document.getElementById('minutes');
    const secondsEl       = document.getElementById('seconds');

    let allVideos = [];
    let selectedSubject = null;
    let selectedTeacher = null;
    let isLoggedIn = false;

    /* ===== أدوات مساعدة لليوتيوب ===== */
    const isYouTubeUrl = (url='') => /youtu\.be|youtube\.com/.test(url);
    function getYouTubeId(url=''){
      try{
        const u = new URL(url);
        if (u.hostname.includes('youtu.be')) return u.pathname.replace('/','');
        if (u.searchParams.get('v')) return u.searchParams.get('v');
        const m = u.pathname.match(/\/embed\/([^/?#]+)/);
        return m ? m[1] : '';
      }catch{ return ''; }
    }
    const getYTThumb = (id) => id ? `https://img.youtube.com/vi/${id}/hqdefault.jpg` : '';

    /* ===== الرسالة المنبثقة ===== */
    function showMessage(msg, type="success", duration=2000){
      const box = document.getElementById('messageBox');
      const card = box.querySelector('.card');
      card.textContent = msg;
      box.className = type; // success | error
      box.style.display = 'flex';
      clearTimeout(showMessage._t);
      showMessage._t = setTimeout(()=>{ box.style.display='none'; }, duration);
    }

    /* ===== ربط أزرار الدخول (بطريقة آمنة لمنع listeners مزدوجة) ===== */
    function attachLoginHandlers(){
      const btn = document.getElementById('loginBtn');
      const input = document.getElementById('studentCode');
      if (btn) btn.onclick = loginWithCode;
      if (input) input.onkeydown = (e)=>{ if(e.key === 'Enter') loginWithCode(); };
    }
    attachLoginHandlers();

    /* ===== تسجيل الدخول بالكود ===== */
    function loginWithCode(){
      const inputEl = document.getElementById('studentCode');
      const code = inputEl ? inputEl.value.trim() : '';
      if(!code){ showMessage("⚠ من فضلك ادخل كود الاشتراك","error"); return; }
      localStorage.setItem('studentCode', code);

      const codeRef = ref(db, `codes/${code}/expire`);
      onValue(codeRef, (snapshot)=>{
        const expireValue = snapshot.val();
        const now = Date.now();
        if (expireValue && now <= parseInt(expireValue)) {
          startCountdown(expireValue);
          document.getElementById('login-box').innerHTML = "✅ تم تسجيل الدخول بنجاح";
          showMessage("✅ تم تسجيل الدخول بنجاح","success");
          isLoggedIn = true;
          document.querySelector('.filter-bar').style.display = 'flex';
          videosContainer.innerHTML = '<div style="text-align:center; font-size:18px; color:#ffd700;">اختر مادة لبدء التصفح.</div>';
          teachersFilter.innerHTML = '';
        } else {
          showMessage("❌ الكود غير صحيح أو منتهي","error");
          localStorage.removeItem('studentCode');
          isLoggedIn = false;
          renderLoginRequired();
        }
      }, { onlyOnce: true });
    }

    /* تحقق تلقائي عند الفتح */
    const savedCode = localStorage.getItem('studentCode');
    if (savedCode){
      const codeRef = ref(db, `codes/${savedCode}/expire`);
      onValue(codeRef, (snapshot)=>{
        const expireValue = snapshot.val();
        const now = Date.now();
        if (expireValue && now <= parseInt(expireValue)) {
          startCountdown(expireValue);
          document.getElementById('login-box').innerHTML = "✅ تم تسجيل الدخول بنجاح";
          isLoggedIn = true;
          document.querySelector('.filter-bar').style.display = 'flex';
          videosContainer.innerHTML = '<div style="text-align:center; font-size:18px; color:#ffd700;">اختر مادة لبدء التصفح.</div>';
          teachersFilter.innerHTML = '';
        } else {
          localStorage.removeItem('studentCode');
          isLoggedIn = false;
          renderLoginRequired();
        }
      }, { onlyOnce: true });
    }

    /* ===== العداد التنازلي ===== */
    function startCountdown(endTimestamp){
      const end = parseInt(endTimestamp);
      countdownBox.style.display = 'flex';
      expiredMsg.style.display = 'none';
      const interval = setInterval(()=>{
        const now = Date.now();
        const distance = end - now;

        if (distance <= 0){
          clearInterval(interval);
          countdownBox.style.display = 'none';
          expiredMsg.style.display = 'block';
          isLoggedIn = false;
          localStorage.removeItem('studentCode');

          document.getElementById('login-box').innerHTML = `
            <input type="text" id="studentCode" placeholder="ادخل كود الاشتراك" />
            <button id="loginBtn">دخول</button>
          `;
          attachLoginHandlers();

          videosContainer.innerHTML = '<div style="text-align:center; font-size:18px; color:#ffd700;">❌ يجب إدخال كود اشتراك صالح لتفعيل الفيديوهات</div>';
          teachersFilter.innerHTML = '';
          document.querySelector('.filter-bar').style.display = 'none';
          return;
        }

        const days    = Math.floor(distance / (1000*60*60*24));
        const hours   = Math.floor((distance % (1000*60*60*24)) / (1000*60*60));
        const minutes = Math.floor((distance % (1000*60*60)) / (1000*60));
        const seconds = Math.floor((distance % (1000*60)) / 1000);

        daysEl.textContent    = days;
        hoursEl.textContent   = hours;
        minutesEl.textContent = minutes;
        secondsEl.textContent = seconds;
      }, 1000);
    }

    /* ===== واجهات العرض ===== */
    function renderLoginRequired(){
      videosContainer.innerHTML = '<div style="text-align:center; font-size:18px; color:red;">❌ يجب إدخال كود الاشتراك الخاص بك لتفعيل الفيديوهات</div>';
      teachersFilter.innerHTML = '';
      document.querySelector('.filter-bar').style.display = 'none';
    }

    function renderTeachers(subject){
      if(!isLoggedIn){ renderLoginRequired(); return; }
      teachersFilter.innerHTML = '';
      selectedTeacher = null;

      const teachersSet = new Set(
        allVideos
          .filter(v => (v.subject || '').trim() === subject)
          .map(v => (v.teacher || 'مدرس غير معروف').trim())
      );

      if (teachersSet.size === 0){
        teachersFilter.innerHTML = '<div style="text-align:center; color:#ffd700; font-size:18px;">لا يوجد مدرسون متاحون لهذه المادة.</div>';
        return;
      }

      teachersSet.forEach(teacher=>{
        const btn = document.createElement('button');
        btn.textContent = teacher;
        btn.onclick = ()=>{
          selectedTeacher = teacher;
          [...teachersFilter.children].forEach(c=>c.classList.remove('active'));
          btn.classList.add('active');
          renderVideos(subject, selectedTeacher);
        };
        teachersFilter.appendChild(btn);
      });
    }

    /* ===== دوال تحكم لكل video-wrapper (zoom/rotate/fullscreen/reset) ===== */
    function setTransform(wrapper){
      const iframe = wrapper.querySelector('iframe');
      if (!iframe) return;
      const zoom = Number(wrapper.dataset.zoom || 1);
      const rot = Number(wrapper.dataset.rot || 0);
      iframe.style.transform = `scale(${zoom}) rotate(${rot}deg)`;
    }

    function zoomInBtn(btn){
      const wrapper = btn.closest('.video-wrapper');
      if(!wrapper) return;
      let z = Number(wrapper.dataset.zoom || 1);
      z = Math.min(2.5, +(z + 0.1).toFixed(2));
      wrapper.dataset.zoom = z;
      setTransform(wrapper);
    }
    function zoomOutBtn(btn){
      const wrapper = btn.closest('.video-wrapper');
      if(!wrapper) return;
      let z = Number(wrapper.dataset.zoom || 1);
      z = Math.max(0.5, +(z - 0.1).toFixed(2));
      wrapper.dataset.zoom = z;
      setTransform(wrapper);
    }
    function rotateBtn(btn){
      const wrapper = btn.closest('.video-wrapper');
      if(!wrapper) return;
      let r = Number(wrapper.dataset.rot || 0);
      r = (r + 90) % 360;
      wrapper.dataset.rot = r;
      setTransform(wrapper);
    }
    async function toggleFullscreenBtn(btn){
      const wrapper = btn.closest('.video-wrapper');
      if(!wrapper) return;
      try{
        if (document.fullscreenElement) {
          await document.exitFullscreen();
          wrapper.classList.remove('fullscreen');
        } else {
          if (wrapper.requestFullscreen) await wrapper.requestFullscreen();
          wrapper.classList.add('fullscreen');
        }
      }catch(e){
        console.warn('fullscreen error', e);
      }
    }
    function resetVideoBtn(btn){
      const wrapper = btn.closest('.video-wrapper');
      if(!wrapper) return;
      wrapper.dataset.zoom = '1';
      wrapper.dataset.rot = '0';
      setTransform(wrapper);
      // إذا كانت في وضع كامل الشاشة نخرج
      if (document.fullscreenElement) {
        document.exitFullscreen().catch(()=>{});
      }
    }

    /* ===== عرض الفيديوهات (داخل الصفحة) ===== */
    function renderVideos(subject, teacher=null){
      if(!isLoggedIn){ renderLoginRequired(); return; }
      videosContainer.innerHTML = '';
      selectedSubject = subject;

      let filtered = allVideos.filter(v => (v.subject || '').trim() === subject);
      if (teacher) filtered = filtered.filter(v => ((v.teacher || 'مدرس غير معروف').trim() === teacher));

      if (filtered.length === 0){
        videosContainer.innerHTML = '<div style="text-align:center; font-size:18px; color:#ffd700;">لا توجد فيديوهات لهذه المادة مع هذا المدرس.</div>';
        return;
      }

      filtered.forEach(video=>{
        const box = document.createElement('div');
        box.className = 'video-box';

        const titleEl = document.createElement('div');
        titleEl.className = 'video-title';
        titleEl.textContent = video.title || 'فيديو بدون عنوان';

        const teacherEl = document.createElement('div');
        teacherEl.className = 'video-teacher';
        teacherEl.textContent = 'المدرس: ' + (video.teacher || 'غير معروف');

        box.appendChild(titleEl);
        box.appendChild(teacherEl);

        const youtube = isYouTubeUrl(video.url);
        const ytId = youtube ? getYouTubeId(video.url) : '';
        const thumb = video.imageUrl || (youtube ? getYTThumb(ytId) : '');

        if (youtube){
          const thumbDiv = document.createElement('div');
          thumbDiv.className = 'thumb';
          const img = document.createElement('img');
          img.src = thumb || 'https://via.placeholder.com/300x200?text=YouTube';
          img.alt = 'thumbnail';
          const play = document.createElement('div');
          play.className = 'play-btn';
          play.textContent = '▶';
          thumbDiv.appendChild(img);
          thumbDiv.appendChild(play);

          thumbDiv.onclick = ()=>{
            // استبدال المصغرة بإطار الفيديو + أدوات التحكم
            const wrapper = document.createElement('div');
            wrapper.className = 'video-wrapper';
            wrapper.dataset.zoom = '1';
            wrapper.dataset.rot = '0';

            const iframe = document.createElement('iframe');
            iframe.src = `https://www.youtube.com/embed/${ytId}?autoplay=1&rel=0&modestbranding=1`;
            iframe.setAttribute('frameborder','0');
            iframe.setAttribute('allow','accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen');
            iframe.setAttribute('allowfullscreen','');
            iframe.style.transformOrigin = 'center center';

            wrapper.appendChild(iframe);

            const controls = document.createElement('div');
            controls.className = 'controls';

            const btnZoomIn = document.createElement('button'); btnZoomIn.textContent = '➕ تكبير'; btnZoomIn.onclick = ()=>zoomInBtn(btnZoomIn);
            const btnZoomOut = document.createElement('button'); btnZoomOut.textContent = '➖ تصغير'; btnZoomOut.onclick = ()=>zoomOutBtn(btnZoomOut);
            const btnRotate = document.createElement('button'); btnRotate.textContent = '🔄 قلب'; btnRotate.onclick = ()=>rotateBtn(btnRotate);
            const btnFS = document.createElement('button'); btnFS.textContent = '⛶ ملء الشاشة'; btnFS.onclick = ()=>toggleFullscreenBtn(btnFS);
            const btnReset = document.createElement('button'); btnReset.textContent = '⛔ إعادة ضبط'; btnReset.onclick = ()=>resetVideoBtn(btnReset);

            controls.appendChild(btnZoomIn);
            controls.appendChild(btnZoomOut);
            controls.appendChild(btnRotate);
            controls.appendChild(btnFS);
            controls.appendChild(btnReset);

            wrapper.appendChild(controls);

            thumbDiv.replaceWith(wrapper);
          };

          box.appendChild(thumbDiv);
        } else {
          // ملف mp4 أو رابط مباشر
          const videoEl = document.createElement('video');
          videoEl.controls = true;
          videoEl.style.width = '100%';
          videoEl.style.height = '250px';
          videoEl.style.borderRadius = '10px';
          if (thumb) videoEl.poster = thumb;

          const source = document.createElement('source');
          source.src = video.url;
          source.type = 'video/mp4';
          videoEl.appendChild(source);

          const fallback = document.createElement('div');
          fallback.textContent = 'متصفحك لا يدعم تشغيل الفيديو.';
          box.appendChild(videoEl);
          box.appendChild(fallback);
        }

        videosContainer.appendChild(box);
      });
    }

    // متاح لأزرار المواد
    window.filterVideos = (subject)=>{
      if(!isLoggedIn){ renderLoginRequired(); return; }
      if (subject === 'all'){
        videosContainer.innerHTML = '<div style="text-align:center; font-size:18px; color:#ffd700;">اضغط على اسم المادة للحصول على الفيديوهات.</div>';
        teachersFilter.innerHTML = '';
        selectedSubject = null;
        selectedTeacher = null;
        return;
      }
      selectedSubject = subject;
      selectedTeacher = null;
      renderTeachers(subject);
      videosContainer.innerHTML = '<div style="text-align:center; font-size:18px; color:#ffd700;">اختر مدرسًا لعرض الفيديوهات.</div>';
    };

    /* ===== تحميل الفيديوهات من Realtime Database ===== */
    const videosRef = ref(db, 'videos');
    onValue(videosRef, (snapshot)=>{
      const data = snapshot.val() || {};
      allVideos = Object.keys(data).map(k => {
        const v = data[k] || {};
        let imageUrl = v.imageUrl || '';
        if (!imageUrl && isYouTubeUrl(v.url)){
          const id = getYouTubeId(v.url);
          imageUrl = getYTThumb(id);
        }
        return {
          url: v.url || '',
          subject: v.subject || '',
          title: v.title || '',
          teacher: v.teacher || 'مدرس غير معروف',
          imageUrl
        };
      });

      if (isLoggedIn){
        document.querySelector('.filter-bar').style.display = 'flex';
        videosContainer.innerHTML = '<div style="text-align:center; font-size:18px; color:#ffd700;">اختر مادة لبدء التصفح.</div>';
      } else {
        renderLoginRequired();
      }
      teachersFilter.innerHTML = '';
    }, (err)=>{
      console.error('firebase videos read error', err);
      videosContainer.innerHTML = '<div style="text-align:center; font-size:18px; color:#ffd700;">حدث خطأ أثناء تحميل الفيديوهات.</div>';
    });
  </script>
</body>
</html>
