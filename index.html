<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>THE BEST - تسجيل الطلاب</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<style>
body { font-family: 'Cairo', sans-serif; background: radial-gradient(circle at top left, #141E30, #243B55); color:white; display:flex; justify-content:center; align-items:center; height:100vh; margin:0; }
.container { background: rgba(0,0,0,0.7); padding:40px; border-radius:20px; width:90%; max-width:400px; text-align:center; }
h1 { font-size:36px; margin-bottom:10px; }
input { width:100%; padding:14px; margin:8px 0; border-radius:12px; border:none; font-size:18px; text-align:center; background:#111; color:#fff; }
input:focus { box-shadow:0 0 15px #00f5c4; outline:none; }
button { width:100%; padding:12px; margin:8px 0; border:none; border-radius:8px; font-size:18px; background: linear-gradient(90deg,#00c6ff,#0072ff); color:white; cursor:pointer; transition:all 0.3s ease; }
button:hover { transform:scale(1.05); box-shadow:0 0 20px #00f5c4; }
#deleteBtn { background:#ff4f4f; display:none; }

/* ✅ ستايل التوست */
.toast {
  position: fixed;
  bottom: 30px;
  right: 50%;
  transform: translateX(50%);
  background: rgba(0,0,0,0.85);
  color: #fff;
  padding: 14px 20px;
  border-radius: 10px;
  font-size: 16px;
  z-index: 9999;
  opacity: 0;
  transition: opacity 0.5s ease, transform 0.5s ease;
}
.toast.show {
  opacity: 1;
  transform: translateX(50%) translateY(-10px);
}
.toast.success { background: #00c896; }
.toast.error { background: #ff4f4f; }
.toast.warning { background: #ff9800; }
</style>
</head>
<body>

<div class="container">
  <h1>THE BEST</h1>
  <input type="text" id="studentName" placeholder="الاسم الكامل">
  <input type="text" id="studentPhone" placeholder="رقم الهاتف">
  <button id="submitBtn" disabled>جارٍ الإعداد...</button>
  <button id="deleteBtn">حذف الطلب</button>
</div>

<!-- ✅ عنصر للتوست -->
<div id="toast" class="toast"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCdhj73cKJc2J2_tDHw2-89EemZx-EGMJQ",
  authDomain: "alamer-526ff.firebaseapp.com",
  databaseURL: "https://alamer-526ff-default-rtdb.firebaseio.com",
  projectId: "alamer-526ff",
  storageBucket: "alamer-526ff.appspot.com",
  messagingSenderId: "523879269039",
  appId: "1:523879269039:web:634861aa34641bfebf8a5a"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const submitBtn = document.getElementById("submitBtn");
const deleteBtn = document.getElementById("deleteBtn");
const toast = document.getElementById("toast");

let currentUid = localStorage.getItem("localUid") || null;

// ✅ دالة عرض التوست
function showToast(message, type="success"){
  toast.textContent = message;
  toast.className = "toast " + type + " show";
  setTimeout(()=>{ toast.className = "toast " + type; }, 3000);
}

// تسجيل الدخول المجهول
function initAuth() {
  submitBtn.disabled = true;
  showToast("جارٍ الاتصال بـ server...", "warning");

  auth.signInAnonymously()
    .then(res => {
      if(res.user && res.user.uid){
        currentUid = res.user.uid;
        localStorage.setItem("localUid", currentUid);
        submitBtn.disabled = false;
        checkIfApproved();
        checkExistingRequest();
        listenForDeletion();
      } else {
        throw new Error("لم يتم الحصول على UID.");
      }
    })
    .catch(err => {
      showToast("❌ فشل تسجيل الدخول المجهول.", "error");
      console.error("Auth Error:", err);
    });
}

initAuth();

// التحقق إذا الطالب مقبول مسبقًا
function checkIfApproved(){
  if(!currentUid) return;
  db.ref("approvedStudents").orderByChild("deviceId").equalTo(currentUid).once("value")
    .then(snap=>{
      if(snap.exists()){
        localStorage.setItem("approved","true");
        window.location.href="home.html"; 
      } else {
        localStorage.removeItem("approved");
      }
    });
}

// مراقبة الحذف أو النقل
function listenForDeletion(){
  if(!currentUid) return;
  db.ref("approvedStudents").orderByChild("deviceId").equalTo(currentUid).on("value", snap=>{
    if(snap.exists()){
      localStorage.setItem("approved","true");
    } else {
      if(localStorage.getItem("approved") === "true"){ 
        localStorage.removeItem("approved");
        showToast("❌ تم حذفك من النظام، يرجى إعادة التسجيل.", "error");
        setTimeout(()=>{ location.reload(); },1500);
      }
    }
  });
}

// التحقق من وجود طلب سابق
function checkExistingRequest(){
  if(!currentUid) return;
  db.ref("pendingStudents/"+currentUid).once("value")
    .then(snap => {
      if(snap.exists()){
        showToast("⚠ لديك طلب معلق، يمكنك حذفه.", "warning");
        deleteBtn.style.display = "block";
      } else {
        deleteBtn.style.display = "none";
      }
    });
}

// إرسال الطلب
submitBtn.addEventListener("click", ()=>{
  if(!currentUid){
    showToast("❌ UID غير موجود، لا يمكن إرسال الطلب.", "error");
    return;
  }

  const name = document.getElementById("studentName").value.trim();
  const phone = document.getElementById("studentPhone").value.trim();

  if(!name || !phone){
    showToast("❌ يرجى ملء جميع الحقول.", "error");
    return;
  }

  if(!/^\d{11}$/.test(phone)){
    showToast("❌ رقم الهاتف غير صالح.", "error");
    return;
  }

  // التحقق من الموافقة المسبقة
  db.ref("approvedStudents").orderByChild("phone").equalTo(phone).once("value")
    .then(snap2=>{
      if(snap2.exists()){
        const approvedKey = Object.keys(snap2.val())[0];
        const approvedData = snap2.val()[approvedKey];

        if(approvedData.deviceId && approvedData.deviceId !== currentUid){
          showToast("❌ هذا الحساب مسجل من جهاز آخر.", "error");
          return;
        }

        if(!approvedData.deviceId){
          db.ref("approvedStudents/"+approvedKey).update({ deviceId: currentUid });
        }

        showToast("✅ تم الموافقة مسبقًا على هذا الرقم.", "success");
        localStorage.setItem("approved","true");
        setTimeout(()=>{ window.location.href="home.html"; },1000);
      } else {
        db.ref("pendingStudents/"+currentUid).set({
          name, phone, deviceId: currentUid, timestamp: Date.now()
        }).then(()=>{
          showToast("✅ تم إرسال طلبك، انتظر الموافقة.", "success");
          deleteBtn.style.display = "block";
        }).catch(err=>{
          showToast("❌ حدث خطأ أثناء إرسال الطلب.", "error");
          console.error(err);
        });
      }
    })
    .catch(err=>{
      showToast("❌ خطأ أثناء التحقق من الموافقة.", "error");
      console.error(err);
    });
});

// حذف الطلب
deleteBtn.addEventListener("click", ()=>{
  if(!currentUid) return;
  db.ref("pendingStudents/"+currentUid).remove()
    .then(()=>{
      showToast("✅ تم حذف الطلب بنجاح.", "success");
      deleteBtn.style.display="none";
    })
    .catch(err=>{
      showToast("❌ حدث خطأ أثناء الحذف.", "error");
      console.error(err);
    });
});
</script>

</body>
</html>
