<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>THE BEST - تسجيل الطلاب</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<style>
body { font-family: 'Cairo', sans-serif; background: radial-gradient(circle at top left, #141E30, #243B55); color:white; display:flex; justify-content:center; align-items:center; height:100vh; margin:0; }
.container { background: rgba(0,0,0,0.7); padding:40px; border-radius:20px; width:90%; max-width:400px; text-align:center; }
h1 { font-size:36px; margin-bottom:10px; }
input { width:100%; padding:14px; margin:8px 0; border-radius:12px; border:none; font-size:18px; text-align:center; background:#111; color:#fff; }
input:focus { box-shadow:0 0 15px #00f5c4; outline:none; }
button { width:100%; padding:12px; margin:8px 0; border:none; border-radius:8px; font-size:18px; background: linear-gradient(90deg,#00c6ff,#0072ff); color:white; cursor:pointer; transition:all 0.3s ease; }
button:hover { transform:scale(1.05); box-shadow:0 0 20px #00f5c4; }
#error { color:#ff4f4f; margin-top:10px; }
#success { color:#00f5c4; margin-top:10px; }
#deleteBtn { background:#ff4f4f; display:none; }
</style>
</head>
<body>

<div class="container">
<h1>THE BEST</h1>
<input type="text" id="studentName" placeholder="الاسم الكامل">
<input type="text" id="studentPhone" placeholder="رقم الهاتف">
<button id="submitBtn" disabled>جارٍ الإعداد...</button>
<button id="deleteBtn">حذف الطلب</button>
<p id="error"></p>
<p id="success"></p>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCdhj73cKJc2J2_tDHw2-89EemZx-EGMJQ",
  authDomain: "alamer-526ff.firebaseapp.com",
  databaseURL: "https://alamer-526ff-default-rtdb.firebaseio.com",
  projectId: "alamer-526ff",
  storageBucket: "alamer-526ff.appspot.com",
  messagingSenderId: "523879269039",
  appId: "1:523879269039:web:634861aa34641bfebf8a5a"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const submitBtn = document.getElementById("submitBtn");
const deleteBtn = document.getElementById("deleteBtn");
const errorEl = document.getElementById("error");
const successEl = document.getElementById("success");

let currentUid = localStorage.getItem("localUid") || null;

// تسجيل الدخول المجهول
function initAuth() {
  submitBtn.disabled = true;
  errorEl.textContent = "جارٍ الاتصال بـ Firebase...";

  auth.signInAnonymously()
    .then(res => {
      if(res.user && res.user.uid){
        currentUid = res.user.uid;
        localStorage.setItem("localUid", currentUid);
        submitBtn.disabled = false;
        errorEl.textContent = "";
        console.log("تم تسجيل الدخول المجهول UID:", currentUid);

        // ===== تحقق الموافقة من Firebase + deviceId =====
        const currentDevice = navigator.userAgent || "unknown";
        db.ref("approvedStudents/"+currentUid).once("value")
          .then(snap=>{
            if(snap.exists()){
              const data = snap.val();
              if(data.deviceId === currentDevice){
                localStorage.setItem("approved","true");
                window.location.href="home.html";
              } else {
                localStorage.removeItem("approved");
                errorEl.textContent = "❌ تم تسجيل هذا الحساب من جهاز آخر أو تم حذفه.";
              }
            } else {
              localStorage.removeItem("approved");
            }
          }).catch(err=>{
            console.error(err);
            localStorage.removeItem("approved");
          });
        // ===== نهاية التحقق =====

        checkExistingRequest();
      } else {
        throw new Error("لم يتم الحصول على UID.");
      }
    })
    .catch(err => {
      errorEl.textContent = "❌ فشل تسجيل الدخول المجهول. تحقق من إعدادات Firebase Auth.";
      console.error("Auth Error:", err);
    });
}

initAuth();

// التحقق من وجود طلب سابق
function checkExistingRequest(){
  if(!currentUid) return;
  db.ref("pendingStudents/"+currentUid).once("value")
    .then(snap => {
      if(snap.exists()){
        errorEl.textContent = "⚠ لديك طلب معلق، يمكنك حذفه وإعادة التسجيل.";
        deleteBtn.style.display = "block";
      } else {
        deleteBtn.style.display = "none";
        errorEl.textContent = "";
      }
    })
    .catch(err => {
      errorEl.textContent = "❌ حدث خطأ أثناء التحقق من الطلبات.";
      console.error(err);
    });
}

// إرسال الطلب
submitBtn.addEventListener("click", ()=>{
  if(!currentUid){
    errorEl.textContent = "❌ UID غير موجود، لا يمكن إرسال الطلب.";
    return;
  }

  const name = document.getElementById("studentName").value.trim();
  const phone = document.getElementById("studentPhone").value.trim();
  errorEl.textContent = "";
  successEl.textContent = "";

  if(!name || !phone){
    errorEl.textContent = "❌ يرجى ملء جميع الحقول.";
    return;
  }

  if(!/^\d{11}$/.test(phone)){
    errorEl.textContent = "❌ رقم الهاتف غير صالح.";
    return;
  }

  // التحقق من الموافقة المسبقة
  db.ref("approvedStudents").orderByChild("phone").equalTo(phone).once("value")
    .then(snap2=>{
      if(snap2.exists()){
        const dataKey = Object.keys(snap2.val())[0];
        const deviceId = navigator.userAgent || "unknown";
        db.ref("approvedStudents/"+dataKey).update({ deviceId }).then(()=>{
          successEl.textContent = "✅ تم الموافقة مسبقًا على هذا الرقم.";
          localStorage.setItem("approved","true");
          setTimeout(()=>{ window.location.href="home.html"; },1000);
        });
      } else {
        // إرسال الطلب
        db.ref("pendingStudents/"+currentUid).set({
          name, phone, timestamp:Date.now()
        }).then(()=>{
          successEl.textContent = "✅ تم إرسال طلبك، انتظر الموافقة.";
          deleteBtn.style.display = "block";
        }).catch(err=>{
          errorEl.textContent = "❌ حدث خطأ أثناء إرسال الطلب.";
          console.error(err);
        });
      }
    }).catch(err=>{
      errorEl.textContent = "❌ حدث خطأ أثناء التحقق من الموافقة.";
      console.error(err);
    });
});

// حذف الطلب
deleteBtn.addEventListener("click", ()=>{
  if(!currentUid) return;
  db.ref("pendingStudents/"+currentUid).remove()
    .then(()=>{
      successEl.textContent = "✅ تم حذف الطلب بنجاح.";
      deleteBtn.style.display="none";
      errorEl.textContent="";
    })
    .catch(err=>{
      errorEl.textContent = "❌ حدث خطأ أثناء الحذف.";
      console.error(err);
    });
});

// عند إعادة الدخول، إذا تم القبول مسبقًا يتم التحويل مباشرة
if(localStorage.getItem("approved")==="true"){
  window.location.href="home.html";
}
</script>

</body>
</html>
