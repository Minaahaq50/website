<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>THE BEST - تسجيل دخول الطالب</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
    body { margin:0; height:100vh; display:flex; align-items:center; justify-content:center; background: radial-gradient(circle at top left, #141E30, #243B55); color:white; }
    .login-box { background: rgba(0,0,0,0.6); padding:40px; border-radius:20px; text-align:center; width:90%; max-width:400px; }
    .login-box h1 { font-size:36px; margin-bottom:10px; }
    .login-box h2 { font-size:20px; margin-bottom:20px; }
    .login-box input[type="text"] { padding:14px; width:100%; border-radius:12px; border:none; outline:none; font-size:18px; text-align:center; background:#111; color:#fff; margin-bottom:15px; box-shadow:0 0 10px rgba(0,255,255,0.3); }
    .login-box input[type="text"]:focus { box-shadow:0 0 15px #00f5c4; }
    .login-box button { width:100%; padding:12px; font-size:18px; border:none; border-radius:8px; background: linear-gradient(90deg,#00c6ff,#0072ff); color:white; cursor:pointer; transition:all 0.4s ease; }
    .login-box button:hover { transform:scale(1.05); box-shadow:0 0 20px #00f5c4; }
    #status { margin-top:20px; font-size:18px; }
    .error { color:#ff4f4f; }
    .success { color:#00f5c4; }
  </style>
</head>
<body>
  <div class="login-box">
    <h1>THE BEST</h1>
    <h2>ادخل كود الدخول</h2>
    <input type="text" id="codeInput" placeholder="CODE">
    <button onclick="verifyCode()">تسجيل الدخول</button>
    <p id="status"></p>
  </div>

  <script>
    // إعداد Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCdhj73cKJc2J2_tDHw2-89EemZx-EGMJQ",
      authDomain: "alamer-526ff.firebaseapp.com",
      databaseURL: "https://alamer-526ff-default-rtdb.firebaseio.com",
      projectId: "alamer-526ff",
      storageBucket: "alamer-526ff.appspot.com",
      messagingSenderId: "523879269039",
      appId: "1:523879269039:web:634861aa34641bfebf8a5a"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let currentUid = null;

    // استخدام UID ثابت لكل جهاز
    let localUid = localStorage.getItem("localUid");
    if (!localUid) {
      // تسجيل مجهول مؤقت لحفظ UID
      auth.signInAnonymously().then(res => {
        localUid = res.user.uid;
        localStorage.setItem("localUid", localUid);
        currentUid = localUid;
      });
    } else {
      currentUid = localUid;
    }

    // التحقق من الكود
    function verifyCode() {
      const code = document.getElementById("codeInput").value.trim();
      const status = document.getElementById("status");
      status.textContent = "جارٍ التحقق...";
      status.className = "";

      db.ref("codes").once("value").then(snapshot => {
        let found = false;
        snapshot.forEach(child => {
          const data = child.val();
          const key = child.key;

          if (data.code === code) {
            found = true;
            const now = Date.now();

            if (data.expire <= now) {
              status.textContent = "⛔ الكود منتهي الصلاحية.";
              status.className = "error";
            } else if (data.deviceId && data.deviceId !== currentUid) {
              status.textContent = "⚠ هذا الكود مفعل على جهاز آخر.";
              status.className = "error";
            } else {
              // تحديث deviceId
              db.ref("codes/" + key).update({ deviceId: currentUid }).then(() => {
                status.textContent = "✅ تم تسجيل الدخول بنجاح!";
                status.className = "success";
                localStorage.setItem("savedCode", code);
                setTimeout(() => { window.location.href = "home.html"; }, 1000);
              }).catch(err => {
                status.textContent = "❌ خطأ في التفعيل.";
                status.className = "error";
                console.error(err);
              });
            }
          }
        });

        if (!found) {
          status.textContent = "❌ الكود غير صحيح.";
          status.className = "error";
        }
      });
    }
  </script>
</body>
</html>
